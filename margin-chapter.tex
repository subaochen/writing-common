% see https://tex.stackexchange.com/questions/202450/show-current-chapter-number-on-each-page-margin-with-appendix
% 在\appendix之前执行\cleardoublepage
% 在页边显示章节序号
\usepackage[contents={},opacity=1,scale=1,color=white]{background}
\usepackage{tikzpagenodes}
\usepackage{totcount}
%\usepackage{shorttoc}
\usetikzlibrary{calc}
\usepackage{assoccnt}

\newif\ifMaterial
\definecolor{light-blue}{rgb}{0.8,0.85,1}

\newlength\LabelSize
\setlength\LabelSize{2.5cm}

% auxiliary counter
\newcounter{chapshift}
\setcounter{chapshift}{-1}
\DeclareAssociatedCounters{chapter}{chapshift}

\AtBeginDocument{%
    \regtotcounter{chapter}
    \message{chapter totvalue is \totvalue{chapter}}
    \ifnum\totvalue{chapter}>0\relax
        \setlength\LabelSize{\dimexpr\textheight/\totvalue{chapter}\relax}
        \ifdim\LabelSize>2.5cm\relax
            \global\setlength\LabelSize{2.5cm}
        \fi
    \fi
}

\newcommand\AddLabels{%
\Materialtrue%
\AddEverypageHook{%
\ifMaterial%
\ifodd\value{page} %
 \backgroundsetup{
  angle=90,
  position={current page.east|-current page text area.north  east},
  vshift=12pt,
  hshift=-\thechapshift*\LabelSize,%是否可以根据hshift超出了\textheight来进行回退处理？
  contents={%
  \tikz\node[fill=light-blue,anchor=west,text width=\LabelSize,
    align=center,text height=15pt,text depth=13pt,font=\large\sffamily] {\thechapter};
  }%
 }
 \else
 \backgroundsetup{
  angle=90,
  position={current page.west|-current page text area.north west},
  vshift=-12pt,
  hshift=-\thechapshift*\LabelSize,
  contents={%
  \tikz\node[fill=light-blue,anchor=west,text width=\LabelSize,
    align=center,text height=15pt,text depth=13pt,font=\large\sffamily] {\rotatebox{180}{\thechapter}};
  }%
 }
 \fi
 \BgMaterial%
\else\relax\fi}%
}

\newcommand\RemoveLabels{\Materialfalse}

